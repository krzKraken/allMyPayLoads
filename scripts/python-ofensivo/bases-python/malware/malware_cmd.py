#!/usr/bin/env python3

import os
import platform
import signal
import smtplib
import subprocess
import sys
from email.mime.text import MIMEText

from dotenv import load_dotenv
from termcolor import colored

load_dotenv()
GMAIL_PASS = os.getenv("APPPASS", "")
SENDER_MAIL = os.getenv("SENDER_MAIL", "")
RECIPE_MAIL = os.getenv("RECIPE_MAIL", "")

OS = platform.system()


# NOTE: Send emails
def send_email(subject, body, sender, recipients, password):
    if True:
        print(
            colored(
                f"[+] Enviando correo...\nfrom: {sender}\nto:{recipients}\ncontent:{body}\n"
            )
        )

    # WARN: se requiere clave de app de google para su uso.
    msg = MIMEText(body)
    msg["Subject"] = subject
    msg["From"] = sender
    msg["To"] = ", ".join(recipients)

    with smtplib.SMTP_SSL("smtp.gmail.com", 465) as smtp_server:
        smtp_server.login(sender, password)
        smtp_server.sendmail(sender, recipients, msg.as_string())

    print(f"\n[+] Message sent!\n")


def def_handler(sig, frame):
    print(colored(f"\n[-] Saliendo...\n", "red"))
    sys.exit(1)


signal.signal(signal.SIGINT, def_handler)


def run_command(command):
    output_command = subprocess.check_output(command, shell=True)
    print(colored(f"\n[+] Estas opeando desde el SO: {OS}", "green"))
    if OS == "Linux":
        output_command = output_command.decode()
    elif OS == "Windows":
        output_command = output_command.decode("cp850")
    elif OS == "Darwin":
        output_command = output_command.decode()
    else:
        print(colored(f"\n[!] Sistema operativo no detectado...\n", "red"))
        output_command = ""
    return output_command


if __name__ == "__main__":
    # NOTE: Ejecucion de comandos y reporte a mail
    output_command = run_command("ifconfig")
    send_email(
        "Command Excecution", output_command, SENDER_MAIL, [RECIPE_MAIL], GMAIL_PASS
    )

    print(colored(f"[+] Output command for {OS}: \n{output_command}", "blue"))
